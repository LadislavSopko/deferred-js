(function(e){function t(e){return Object.prototype.toString.call(e)==="[object Array]"}function n(e,n){if(t(e))for(var r=0;r<e.length;r++)n(e[r]);else n(e)}function r(e){var i="pending",s=[],o=[],u=[],a=null,f={done:function(){for(var e=0;e<arguments.length;e++){if(!arguments[e])continue;if(t(arguments[e])){var n=arguments[e];for(var r=0;r<n.length;r++)i==="resolved"&&n[r].apply(this,a),s.push(n[r])}else i==="resolved"&&arguments[e].apply(this,a),s.push(arguments[e])}return this},fail:function(){for(var e=0;e<arguments.length;e++){if(!arguments[e])continue;if(t(arguments[e])){var n=arguments[e];for(var r=0;r<n.length;r++)i==="rejected"&&n[r].apply(this,a),o.push(n[r])}else i==="rejected"&&arguments[e].apply(this,a),o.push(arguments[e])}return this},progress:function(){for(var e=0;e<arguments.length;e++){if(!arguments[e])continue;if(t(arguments[e])){var n=arguments[e];for(var r=0;r<n.length;r++)i=="pending"&&u.push(n[r])}else i==="pending"&&u.push(arguments[e])}return this},then:function(){arguments.length>1&&arguments[1]&&this.fail(arguments[1]),arguments.length>0&&arguments[0]&&this.done(arguments[0]),arguments.length>2&&arguments[2]&&this.progress(arguments[2])},promise:function(e){if(e==null)return f;for(var t in f)e[t]=f[t];return e},state:function(){return i},debug:function(){console.log("[debug]",s,o,i)},isRejected:function(){return i=="rejected"},isResolved:function(){return i=="resolved"},pipe:function(e,t,i){return r(function(r){n(e,function(e){typeof e=="function"?l.done(function(){var t=e.apply(this,arguments);t&&typeof t=="function"?t.promise().then(r.resolve,r.reject,r.notify):r.resolve(t)}):l.done(r.resolve)}),n(t,function(e){typeof e=="function"?l.fail(function(){var t=e.apply(this,arguments);t&&typeof t=="function"?t.promise().then(r.resolve,r.reject,r.notify):r.reject(t)}):l.fail(r.reject)})}).promise()}},l={resolveWith:function(e){if(i=="pending"){i="resolved";var t=a=arguments.length>1?arguments[1]:[];for(var n=0;n<s.length;n++)s[n].apply(e,t)}return this},rejectWith:function(e){if(i=="pending"){i="rejected";var t=a=arguments.length>1?arguments[1]:[];for(var n=0;n<o.length;n++)o[n].apply(e,t)}return this},notifyWith:function(e){if(i=="pending"){var t=a=arguments.length>1?arguments[1]:[];for(var n=0;n<u.length;n++)u[n].apply(e,t)}return this},resolve:function(){return this.resolveWith(this,arguments)},reject:function(){return this.rejectWith(this,arguments)},notify:function(){return this.notifyWith(this,arguments)}},c=f.promise(l);return e&&e.apply(c,[c]),c}r.when=function(){if(arguments.length<2){var e=arguments.length?arguments[0]:undefined;return e&&typeof e.isResolved=="function"&&typeof e.isRejected=="function"?e.promise():r().resolve(e).promise()}return function(e){var t=r(),n=e.length,i=0,s=new Array(n);for(var o=0;o<e.length;o++)(function(r){e[r].done(function(){console.log("resolved"),s[r]=arguments.length<2?arguments[0]:arguments,++i==n&&t.resolve.apply(t,s)}).fail(function(){console.log("rejected"),t.reject(arguments)})})(o);return t.promise()}(arguments)},e.Deferred=r})(window);